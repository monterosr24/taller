<div class="data-table-container">
    <!-- Search Bar -->
    <div class="table-toolbar" *ngIf="tableConfig.enableSearch">
        <mat-form-field class="search-field" appearance="outline">
            <mat-label>Search</mat-label>
            <input matInput [(ngModel)]="searchValue" (keyup)="applyFilter($event)" placeholder="Search...">
            <button mat-icon-button matSuffix *ngIf="searchValue" (click)="clearFilter()" aria-label="Clear">
                <mat-icon>close</mat-icon>
            </button>
            <mat-icon matPrefix>search</mat-icon>
        </mat-form-field>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="loading">
        <mat-spinner diameter="50"></mat-spinner>
        <p>{{ tableConfig.loadingMessage }}</p>
    </div>

    <!-- Table -->
    <div class="table-wrapper" *ngIf="!loading">
        <table mat-table [dataSource]="dataSource" matSort (matSortChange)="onSortChange($event)"
            class="data-table mat-elevation-z2" [class.sticky-header]="tableConfig.stickyHeader">

            <!-- Selection Column -->
            <ng-container matColumnDef="select" *ngIf="tableConfig.enableSelection">
                <th mat-header-cell *matHeaderCellDef class="selection-cell">
                    <mat-checkbox (change)="toggleAllRows()" [checked]="isAllSelected()"
                        [indeterminate]="selectedRows.size > 0 && !isAllSelected()">
                    </mat-checkbox>
                </th>
                <td mat-cell *matCellDef="let row" class="selection-cell">
                    <mat-checkbox (click)="$event.stopPropagation()" (change)="toggleRowSelection(row)"
                        [checked]="isRowSelected(row)">
                    </mat-checkbox>
                </td>
            </ng-container>

            <!-- Row Number Column -->
            <ng-container matColumnDef="rowNumber" *ngIf="tableConfig.showRowNumbers">
                <th mat-header-cell *matHeaderCellDef class="row-number-cell">#</th>
                <td mat-cell *matCellDef="let row; let i = index" class="row-number-cell">
                    {{ (dataSource.paginator ? dataSource.paginator.pageIndex * dataSource.paginator.pageSize : 0) + i +
                    1 }}
                </td>
            </ng-container>

            <!-- Data Columns -->
            <ng-container *ngFor="let column of columns" [matColumnDef]="column.key.toString()">
                <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column.sortable ? column.key.toString() : ''"
                    [disabled]="!column.sortable" [style.width]="column.width" [ngClass]="getColumnCssClass(column)">
                    <div class="header-content">
                        <span class="header-text">{{ column.header }}</span>

                        <!-- Inline Filter (only when enableColumnFilters is true) -->
                        <div class="column-filter" *ngIf="tableConfig.enableColumnFilters && column.filter">
                            <!-- Text Filter -->
                            <mat-form-field *ngIf="column.filter.type === 'text'" class="filter-field"
                                appearance="outline" subscriptSizing="dynamic">
                                <input matInput [placeholder]="column.filter.placeholder || 'Filter'"
                                    (keyup)="applyColumnFilter(column.key.toString(), $any($event.target).value)"
                                    autocomplete="off">
                            </mat-form-field>

                            <!-- Select Filter -->
                            <mat-form-field *ngIf="column.filter.type === 'select'" class="filter-field"
                                appearance="outline" subscriptSizing="dynamic">
                                <mat-select [placeholder]="column.filter.placeholder || 'All'"
                                    (selectionChange)="applyColumnFilter(column.key.toString(), $event.value)">
                                    <mat-option value="">All</mat-option>
                                    <mat-option *ngFor="let option of column.filter.options" [value]="option.value">
                                        {{ option.label }}
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </div>
                    </div>
                </th>

                <td mat-cell *matCellDef="let row" [ngClass]="getColumnCssClass(column)">
                    <!-- Custom Template -->
                    <ng-container *ngIf="column.cellTemplate; else defaultCell">
                        <ng-container
                            *ngTemplateOutlet="column.cellTemplate; context: { $implicit: row, value: getCellValue(row, column) }">
                        </ng-container>
                    </ng-container>

                    <!-- Default Cell -->
                    <ng-template #defaultCell>
                        {{ getCellValue(row, column) }}
                    </ng-template>
                </td>
            </ng-container>

            <!-- Actions Column -->
            <ng-container matColumnDef="actions" *ngIf="actions.length > 0">
                <th mat-header-cell *matHeaderCellDef class="actions-cell">Actions</th>
                <td mat-cell *matCellDef="let row" class="actions-cell">
                    <button mat-icon-button [matMenuTriggerFor]="actionMenu" (click)="$event.stopPropagation()">
                        <mat-icon>more_vert</mat-icon>
                    </button>
                    <mat-menu #actionMenu="matMenu">
                        <button mat-menu-item *ngFor="let action of actions" [hidden]="!isActionVisible(action, row)"
                            [disabled]="isActionDisabled(action, row)" (click)="executeAction(action, row, $event)">
                            <mat-icon *ngIf="action.icon">{{ action.icon }}</mat-icon>
                            <span>{{ action.label }}</span>
                        </button>
                    </mat-menu>
                </td>
            </ng-container>

            <!-- Header Row -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: tableConfig.stickyHeader"></tr>

            <!-- Data Rows -->
            <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.clickable]="tableConfig.enableRowClick"
                [class.selected]="isRowSelected(row)" (click)="onRowClick(row)">
            </tr>

            <!-- No Data Row -->
            <tr class="mat-row no-data-row" *matNoDataRow>
                <td class="mat-cell" [attr.colspan]="displayedColumns.length">
                    <div class="no-data-message">
                        <mat-icon>inbox</mat-icon>
                        <p>{{ tableConfig.emptyMessage }}</p>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <!-- Paginator -->
    <mat-paginator *ngIf="tableConfig.enablePagination && !loading" [length]="dataSource.data.length"
        [pageSize]="tableConfig.defaultPageSize" [pageSizeOptions]="tableConfig.pageSizeOptions"
        (page)="onPageChange($event)" showFirstLastButtons>
    </mat-paginator>
</div>